---
interface Props {
  src: string;
  alt: string;
  speed?: number;
  class?: string;
}

const { src, alt, speed = 0.5, class: className = '' } = Astro.props;
const id = `parallax-${Math.random().toString(36).substr(2, 9)}`;
---

<div class={`parallax-container ${className}`} data-parallax-id={id} data-speed={speed}>
  <img src={src} alt={alt} class="parallax-image" loading="eager" />
</div>

<style>
  .parallax-container {
    position: relative;
    overflow: hidden;
    width: 100%;
    height: 100%;
  }
  
  .parallax-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    will-change: transform;
    transition: transform 0.1s ease-out;
  }
</style>

<script>
  const container = document.querySelector(`[data-parallax-id="${id}"]`);
  if (container) {
    const image = container.querySelector('.parallax-image') as HTMLElement;
    const speed = parseFloat(container.getAttribute('data-speed') || '0.5');
    
    let ticking = false;
    
    function updateParallax() {
      if (!image) return;
      
      const rect = container.getBoundingClientRect();
      const windowHeight = window.innerHeight;
      const elementTop = rect.top;
      const elementHeight = rect.height;
      
      // Calculate if element is in viewport
      if (elementTop + elementHeight > 0 && elementTop < windowHeight) {
        const scrolled = window.scrollY;
        const yPos = -(scrolled * speed);
        image.style.transform = `translate3d(0, ${yPos}px, 0)`;
      }
      
      ticking = false;
    }
    
    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(updateParallax);
        ticking = true;
      }
    }
    
    window.addEventListener('scroll', requestTick, { passive: true });
    updateParallax();
  }
</script>

