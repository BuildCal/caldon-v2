---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase';

export const prerender = false;

// Check if already logged in
const { data: { session } } = await supabase.auth.getSession();
if (session) {
  return Astro.redirect('/admin/opportunities');
}

// Handle form submission
let error = '';
if (Astro.request.method === 'POST') {
  const contentType = Astro.request.headers.get('content-type') || '';
  
  if (contentType.includes('application/x-www-form-urlencoded') || contentType.includes('multipart/form-data')) {
    const formData = await Astro.request.formData();
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    
    const { error: authError } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    
    if (authError) {
      error = authError.message;
    } else {
      return Astro.redirect('/admin/opportunities');
    }
  } else {
    error = 'Invalid request format';
  }
}
---

<BaseLayout title="Admin Login | CALDON">
  <style>
    .login-section {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .login-container {
      max-width: 400px;
      width: 100%;
      padding: 2rem;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
    }
    
    h1 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      color: #525252;
    }
    
    input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
    }
    
    input:focus {
      outline: none;
      border-color: #0a0a0a;
    }
    
    button {
      width: 100%;
      padding: 0.75rem;
      background: #0a0a0a;
      color: #fafafa;
      border: none;
      border-radius: 4px;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    
    button:hover {
      background: #525252;
    }
    
    .error {
      background: #fee2e2;
      color: #dc2626;
      padding: 0.75rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.875rem;
    }
  </style>

  <section class="login-section">
    <div class="login-container">
      <h1>Admin Login</h1>
      
      {error && <p class="error">{error}</p>}
      
      <form method="POST">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required />
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required />
        </div>
        
        <button type="submit">Sign In</button>
      </form>
    </div>
  </section>
</BaseLayout>
